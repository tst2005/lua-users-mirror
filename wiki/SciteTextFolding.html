<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>lua-users wiki: Scite Text Folding</TITLE>
<LINK TYPE="text/css" REL="stylesheet" HREF="../styles/main.css">
</HEAD>
<BODY ><table width="100%" border="0"> <tr><td align=left width="100%"><h1><a href="/cgi-bin/wiki.pl?action=search&amp;string=SciteTextFolding&amp;body=1" title="List pages referring to SciteTextFolding">Scite Text Folding</a></h1></td><td align=right>
    <table cellpadding="0" cellspacing="0" border="0" width="1%">
      <tbody>
        <tr>
            <td><a href="../index.html">
            <img src="../images/nav-logo.png" alt="lua-users home" width="177" height="40" border="0"></a></td>
        </tr>
        <tr>
            <td>
            <table cellpadding="0" cellspacing="0" border="0" width="100%">
                <tbody>
                <tr>
                    <td><img src="../images/nav-elbow.png" alt="" width="48" height="40"></td>
                    <td nowrap valign="middle" width="100%">
                        <a href="../wiki/index.html" class="nav">wiki</a></td>
                </tr>
                </tbody>
            </table>
            </td>
        </tr>
      </tbody>
    </table>
<form method="post" action="../wiki/FindPage.html" enctype="application/x-www-form-urlencoded" style="display:inline; margin:0;">
<input type="hidden" name="action" value="search"  /><input type="text" name="string"  size="20" style="" id="search_query1" /><input type="hidden" name="title" value="1"  /><input type="submit" name=".submit" value="Search" /><input type="hidden" name="body" value="on"  /></form></td></tr> </table>
<br clear=all>
<H3>Outline Mode for Text Documents</H3>
This is a simple extension which allows structured text documents to be viewed in outline, by making folding available.  It is an example of a basic line-driven lexical styler. It currently requires <a href="../wiki/SciteExtMan.html" >SciteExtMan</a>; to install put  <a href="/files/wiki_insecure/editors/SciTE/fold.lua">Files:wiki_insecure/editors/SciTE/fold.lua</a> in your <code>scite_lua</code> directory.
<p>
Text documents of course come in many forms; this extension picks up on some common patterns for fold information.  The default is to use the Wiki convention, where a line begining with a number of '=' characters means a heading:
<pre>

  =Main Heading

  ==Subheading 1

  ==Subheading 2

  ===Sub 2 1

  ===Sub 2 2

</pre>
You can of course change the character used.  For Emacs-style outline files, put this in your properties file:
<pre>

 text.outline.char=*

</pre>
You can specify which files are to be treated as text, and what font to use with the following properties.  For example, I like editing text in the fixed system font (years of using Notepad do that to a person!):
<pre>

text.ext=*.txt;*.doc

text.font.name=Fixedsys

</pre>
Another common style is to use numbered sections, like 1.2.1. (A bureaucratic curse, perhaps, but some people like it). Here is how to set the folder to recognize this style:
<pre>

text.outline.number=1

</pre>
<p>
<H3>Showing outlines</H3>
The standard <code>View|Toggle All Folds</code> command will now work on your document, and you can of course manually fold and unfold in the usual way. It's common for Wiki-style documents to start at '==', and not have a top-level caption.  In that case, you can specify what the starting level is:
<pre>

 text.outline.start=1

</pre>
This will allow you to view the outline for the markup of this page properly. 
<p>
<code>Tools|Show Outline</code> shows all <em>fold lines</em>.
<p>
<H3>Limitations, Implementation and Further Possibilities</H3>
Line-based lexers don't always work properly, since they're expecting the return key to be pressed.  I've provided a <code>Tools|Rescan</code> command to sort the document out if it gets confused;  note that this happens automatically on a buffer switch.
<p>
These functions allow you to set the folding level of the Scintilla control, and then to extract it.  The basic level must start at <code>SC_FOLDLEVELBASE</code>, and any fold lines must in addition have <code>SC_FOLDLEVELHEADERFLAG</code>.  Please note that the fold information generated by real lexers is more complex, and one has to fake bit operations.
<pre class="code">
<span class="keyword">local</span> <span class="keyword">function</span> set_level(i,lev,fold)

  <span class="keyword">local</span> foldlevel = lev + SC_FOLDLEVELBASE

  <span class="keyword">if</span> fold <span class="keyword">then</span> 

     foldlevel = foldlevel + SC_FOLDLEVELHEADERFLAG

     editor.FoldExpanded[i] = <span class="keyword">true</span>

  <span class="keyword">end</span>

  editor.FoldLevel[i] = foldlevel

<span class="keyword">end</span>



<span class="keyword">local</span> <span class="keyword">function</span> get_level(i)

  <span class="keyword">local</span> fold = <span class="keyword">false</span>

  <span class="keyword">local</span> level_flags = editor.FoldLevel[i] - SC_FOLDLEVELBASE

  <span class="keyword">if</span> level_flags - SC_FOLDLEVELHEADERFLAG &gt;= 0 <span class="keyword">then</span>

    fold = <span class="keyword">true</span>

    level_flags = level_flags - SC_FOLDLEVELHEADERFLAG 

  <span class="keyword">end</span>

  <span class="keyword">return</span> level_flags, fold  

<span class="keyword">end</span>

</pre>

I've made this a <a href="../wiki/SciteExtMan.html" >SciteExtMan</a> script, to handle the tedious stuff of setting up command handlers and (most importantly) the <code>OnEditorLine</code> event.  That <em>can</em> get confused with the <code>OnOutputLine</code> event, so if you're using the Lua console extension, expect to get the occaisional odd error message in the output pane.
<p>
I've toyed with the idea of doing <em>automatic level number</em> generation, but it's not trivial to do properly;  one has to renumber items when new items are inserted, etc.  (MS Word gets confused about it).  This is a start at defining a 'major' mode for text documents (to use Emacs terminology), and obviously there would be 'minor' modes as well, like Wiki markup.  It would be cool, for instance, if it automatically detected expressions like <code>editor.FoldLevel[i]</code> and put it in monospaced font markup.
<p>
<a href="../wiki/SteveDonovan.html" >SteveDonovan</a>
<p>
<hr>
<a href="../wiki/RecentChanges.html" >RecentChanges</a> &middot; <a href="/cgi-bin/wiki.pl?action=editprefs" >preferences</a><br>
<a href="/cgi-bin/wiki.pl?action=edit&amp;id=SciteTextFolding" >edit</a> &middot; <a href="/cgi-bin/wiki.pl?action=history&amp;id=SciteTextFolding" >history</a><br>Last edited August 31, 2006 7:48 pm GMT <a href="/cgi-bin/wiki.pl?action=browse&amp;diff=1&amp;id=SciteTextFolding" >(diff)</a>
</body>
</html>