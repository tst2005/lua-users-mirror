<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>lua-users wiki: Iterators Tutorial</TITLE>
<LINK TYPE="text/css" REL="stylesheet" HREF="../styles/main.css">
</HEAD>
<BODY ><table width="100%" border="0"> <tr><td align=left width="100%"><h1><a href="/cgi-bin/wiki.pl?action=search&amp;string=IteratorsTutorial&amp;body=1" title="List pages referring to IteratorsTutorial">Iterators Tutorial</a></h1></td><td align=right>
    <table cellpadding="0" cellspacing="0" border="0" width="1%">
      <tbody>
        <tr>
            <td><a href="../index.html">
            <img src="../images/nav-logo.png" alt="lua-users home" width="177" height="40" border="0"></a></td>
        </tr>
        <tr>
            <td>
            <table cellpadding="0" cellspacing="0" border="0" width="100%">
                <tbody>
                <tr>
                    <td><img src="../images/nav-elbow.png" alt="" width="48" height="40"></td>
                    <td nowrap valign="middle" width="100%">
                        <a href="../wiki/index.html" class="nav">wiki</a></td>
                </tr>
                </tbody>
            </table>
            </td>
        </tr>
      </tbody>
    </table>
<form method="post" action="../wiki/FindPage.html" enctype="application/x-www-form-urlencoded" style="display:inline; margin:0;">
<input type="hidden" name="action" value="search"  /><input type="text" name="string"  size="20" style="" id="search_query1" /><input type="hidden" name="title" value="1"  /><input type="submit" name=".submit" value="Search" /><input type="hidden" name="body" value="on"  /></form></td></tr> </table>
<br clear=all>
<code>for</code> statement iterators were covered in the <a href="../wiki/ForTutorial.html" >ForTutorial</a>. These are some notes on writing your own custom iterators. 
<p>
<H2>Algorithm</H2>
<p>
We can write our own <em>iterators</em> to be called by the <code>for</code> statement. The following Lua pseudo-code describes how the <code>for</code> statement works with iterators:
<p>
<DL>
<dt><dd><pre class="code">
<span class="comment">-- Equivalent to "for var1, ···, varn in explist do block end"</span>

<span class="keyword">do</span>

  <span class="keyword">local</span> iterator, state, var1 = explist

  <span class="keyword">local</span> var2, ... , varn

  <span class="keyword">while</span> <span class="keyword">true</span> <span class="keyword">do</span>

    var1, ..., varn = iterator(state, var1)

    <span class="keyword">if</span> var1 == <span class="keyword">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span>

      <span class="comment">-- for block code</span>

  <span class="keyword">end</span>

<span class="keyword">end</span>

</pre>

</DL>
<p>
The state and current key value are passed into the iterator. The iterator returns the new value of the key and any other values, e.g. the value generated by the iterator. If <code>nil</code> is returned then the <code>for</code> loop is terminated.
<p>
<H2>Simple example</H2>
<p>
The following iterator will return a sequence of squared values. When we return no value (i.e. <code>n&gt;=state</code>), Lua returns <code>nil</code> which terminates iteration. Notice the iterator is returning the <em>next</em> value in the sequence for a given iteration. We use the <code>state</code> to hold the number of iterations we wish to perform.
<p>
<DL>
<dt><dd><pre>

&gt; function square(state,n) if n&lt;state then n=n+1 return n,n*n end end

</pre>
</DL>
<p>
Here is the <code>for</code> statement calling the iterator:
<p>
<DL>
<dt><dd><pre>

&gt; for i,n in square,5,0 do print(i,n) end

1       1

2       4

3       9

4       16

5       25

</pre>
</DL>
<p>
We could wrap the above example up (like <code>pairs()</code>) and provide a <code>squares(nbvals)</code> iterator constructor function. E.g.,
<p>
<DL>
<dt><dd><pre>

&gt; function squares(nbvals) return square,nbvals,0 end  -- iterator,state,initial value

</pre>
</DL>
<p>
Now we can call it like <code>pairs()</code>:
<p>
<DL>
<dt><dd><pre>

&gt; for i,n in squares(5) do print(i,n) end

1       1

2       4

3       9

4       16

5       25

</pre>
</DL>
<p>
<H2>Complicated example</H2>
<p>
The following iterator is similar to ipairs, but allows for multiple tables to be iterated over.
<p>
<DL>
<dt><dd><pre class="code">
<span class="keyword">function</span> <span class="library">ipairs</span>(...)

  <span class="keyword">local</span> t = {...}

  <span class="keyword">local</span> tmp = {...}

  <span class="comment">-- if nothing to iterate over just return a dummy iterator</span>

  <span class="keyword">if</span> #tmp==0 <span class="keyword">then</span>

    <span class="keyword">return</span> <span class="keyword">function</span>() <span class="keyword">end</span>, <span class="keyword">nil</span>, <span class="keyword">nil</span>

  <span class="keyword">end</span>

  <span class="keyword">local</span> <span class="keyword">function</span> mult_ipairs_it(t, i)

    i = i+1

    <span class="keyword">for</span> j=1,#t <span class="keyword">do</span>

      <span class="keyword">local</span> val = t[j][i]

      <span class="keyword">if</span> val == <span class="keyword">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> val <span class="keyword">end</span>

      tmp[j] = val

    <span class="keyword">end</span>

    <span class="keyword">return</span> i, <span class="library">unpack</span>(tmp)

  <span class="keyword">end</span>

  <span class="keyword">return</span> mult_ipairs_it, t, 0

<span class="keyword">end</span>



<span class="keyword">local</span> t1 = {<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>}

<span class="keyword">local</span> t2 = {<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>}



<span class="keyword">for</span> k,v1,v2 <span class="keyword">in</span> <span class="library">ipairs</span>(t1, t2) <span class="keyword">do</span>

  <span class="library">print</span>(k,v1,v2)

<span class="keyword">end</span>

</pre>

</DL>
<p>
<H2>Number Theory Example</H2>
<p>
This iterator produces the prime divisors of its argument. It relies on the obvious fact that the smallest positive divisor, greater than one, of a nonzero integer must be a prime number.
<p>
<DL>
<dt><dd><pre class="code">
primdiv = <span class="keyword">function</span> (n)

   <span class="library">assert</span>(n ~= 0)

   <span class="keyword">if</span> n &lt; 0 <span class="keyword">then</span> n = -n <span class="keyword">end</span>

   <span class="keyword">local</span> f = <span class="keyword">function</span> (s,v) <span class="comment">-- s not used</span>

                   <span class="keyword">local</span> p

                   <span class="keyword">if</span> n == 1 <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span>

                   <span class="keyword">while</span> n%v &gt; 0 <span class="keyword">and</span> v*v &lt; n <span class="keyword">do</span>

                    <span class="keyword">if</span> v == 2 <span class="keyword">then</span> v = 3

                    <span class="keyword">else</span> v = v + 2 <span class="keyword">end</span>

                   <span class="keyword">end</span> <span class="comment">-- while</span>

                   <span class="keyword">if</span> n%v == 0 <span class="keyword">then</span>

                    n = n/v; <span class="keyword">return</span> v

                   <span class="keyword">end</span>

                   <span class="keyword">if</span> v*v &gt; n <span class="keyword">then</span>

                    p = n

                    n = 1; <span class="keyword">return</span> p

                   <span class="keyword">end</span>

                 <span class="keyword">end</span> <span class="comment">-- function</span>

     <span class="keyword">return</span> f,<span class="keyword">nil</span>,2

    <span class="keyword">end</span> <span class="comment">-- function</span>



 <span class="keyword">for</span> p <span class="keyword">in</span> primdiv(84) <span class="keyword">do</span> <span class="library">io.write</span>(p,<span class="string">" "</span>) <span class="keyword">end</span> <span class="comment">--&gt; 2 2 3 7</span>

</pre>

</DL>
<p>
<em><a href="../wiki/RiciLake.html" >RiciLake</a> says: I couldn't resist rewriting that:</em>
<p>
<DL>
<dt><dd><pre class="code">
<span class="keyword">function</span> primdiv(n)

  <span class="library">assert</span>(n ~= 0)

  <span class="keyword">if</span> n &lt; 0 <span class="keyword">then</span> n = -n <span class="keyword">end</span>

  <span class="keyword">local</span> <span class="keyword">function</span> f(_, v)

    <span class="keyword">if</span> n &gt; 1 <span class="keyword">then</span>

      <span class="keyword">while</span> n%v &gt; 0 <span class="keyword">do</span>

        v = v + (v == 2 <span class="keyword">and</span> 1 <span class="keyword">or</span> 2)

        <span class="keyword">if</span> v*v &gt; n <span class="keyword">then</span> v = n <span class="keyword">end</span>

      <span class="keyword">end</span> <span class="comment">-- while</span>

      n = n / v

      <span class="keyword">return</span> v

    <span class="keyword">end</span> <span class="comment">-- if</span>

  <span class="keyword">end</span> <span class="comment">-- function</span>

  <span class="keyword">return</span> f,<span class="keyword">nil</span>,2

<span class="keyword">end</span> <span class="comment">-- function primdiv</span>



<span class="keyword">for</span> p <span class="keyword">in</span> primdiv(84) <span class="keyword">do</span> <span class="library">io.write</span>(p,<span class="string">" "</span>) <span class="keyword">end</span> <span class="comment">--&gt; 2 2 3 7</span>

</pre>

</DL>
<p>
<a href="../wiki/GavinWraith.html" >GavinWraith</a> says: That is much nicer. I do regard, however, the use of  <code>function primdiv(n)</code> as
tantamount to <em>methadone</em> for first-order language junkies.
<p>
<H2>Misc examples</H2>
<p>
<H3>ipairs in Lua</H3>
<p>
<DL>
<dt><dd><pre class="code">
<span class="keyword">function</span> <span class="library">ipairs</span>(t)

  <span class="keyword">local</span> <span class="keyword">function</span> ipairs_it(t, i)

    i = i+1

    <span class="keyword">local</span> v = t[i]

    <span class="keyword">if</span> v ~= <span class="keyword">nil</span> <span class="keyword">then</span>

      <span class="keyword">return</span> i,v

    <span class="keyword">else</span>

      <span class="keyword">return</span> <span class="keyword">nil</span>

    <span class="keyword">end</span>

  <span class="keyword">end</span>

  <span class="keyword">return</span> ipairs_it, t, 0

<span class="keyword">end</span>

</pre>

</DL>
<p>
<H3>Reversed ipairs in Lua</H3>
<p>
<DL>
<dt><dd><pre class="code">
<span class="keyword">function</span> ripairs(t)

  <span class="keyword">local</span> max = 1

  <span class="keyword">while</span> t[max] ~= <span class="keyword">nil</span> <span class="keyword">do</span>

    max = max + 1

  <span class="keyword">end</span>

  <span class="keyword">local</span> <span class="keyword">function</span> ripairs_it(t, i)

    i = i-1

    <span class="keyword">local</span> v = t[i]

    <span class="keyword">if</span> v ~= <span class="keyword">nil</span> <span class="keyword">then</span>

      <span class="keyword">return</span> i,v

    <span class="keyword">else</span>

      <span class="keyword">return</span> <span class="keyword">nil</span>

    <span class="keyword">end</span>

  <span class="keyword">end</span>

  <span class="keyword">return</span> ripairs_it, t, max

<span class="keyword">end</span>

</pre>

</DL>
<p>
<DL>
<dt><dd><pre class="code">
<span class="comment">-- from the end backwards</span>

<span class="keyword">function</span> ripairs(t)

  <span class="keyword">local</span> <span class="keyword">function</span> ripairs_it(t,i)

    i=i-1

    <span class="keyword">local</span> v=t[i]

    <span class="keyword">if</span> v==<span class="keyword">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> v <span class="keyword">end</span>

    <span class="keyword">return</span> i,v

  <span class="keyword">end</span>

  <span class="keyword">return</span> ripairs_it, t, #t+1

<span class="keyword">end</span>

</pre>

</DL>
<p>
<p>
<DL>
<dt><dd><pre class="code">
<span class="comment">-- traversing the whole 'array'</span>

<span class="keyword">function</span> ripairs(t)

  idx={}

  <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="library">pairs</span>(t) <span class="keyword">do</span>

    <span class="keyword">if</span> <span class="library">type</span>(k)==<span class="string">"number"</span> <span class="keyword">then</span> idx[#idx+1]=k <span class="keyword">end</span>

  <span class="keyword">end</span>

  <span class="library">table.sort</span>(idx)

  <span class="keyword">local</span> <span class="keyword">function</span> ripairs_it(t,_)

    <span class="keyword">if</span> #idx==0 <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">nil</span> <span class="keyword">end</span>

    k=idx[#idx]

    idx[#idx]=<span class="keyword">nil</span>

    <span class="keyword">return</span> k,t[k]

  <span class="keyword">end</span>

  <span class="keyword">return</span> ripairs_it, t, <span class="keyword">nil</span>

<span class="keyword">end</span>



t1 = {<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="keyword">nil</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="keyword">nil</span>}

<span class="keyword">for</span> k,v <span class="keyword">in</span> ripairs(t1) <span class="keyword">do</span> <span class="library">print</span>(k,v) <span class="keyword">end</span>

<span class="comment">--&gt; 5 e</span>

<span class="comment">--&gt; 4 d</span>

<span class="comment">--&gt; 2 b</span>

<span class="comment">--&gt; 1 a</span>

</pre>

</DL>
<hr>
<a href="../wiki/RecentChanges.html" >RecentChanges</a> &middot; <a href="/cgi-bin/wiki.pl?action=editprefs" >preferences</a><br>
<a href="/cgi-bin/wiki.pl?action=edit&amp;id=IteratorsTutorial" >edit</a> &middot; <a href="/cgi-bin/wiki.pl?action=history&amp;id=IteratorsTutorial" >history</a><br>Last edited December 9, 2009 11:03 am GMT <a href="/cgi-bin/wiki.pl?action=browse&amp;diff=1&amp;id=IteratorsTutorial" >(diff)</a>
</body>
</html>